<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wildberries — Покупатель</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: linear-gradient(135deg, #f5f7fa 0%, #e4edf9 100%); color: #333; min-height: 100vh; }
    .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; padding: 20px; overflow-y: auto; }
    #login { display: flex; background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%); color: white; justify-content: center; align-items: center; flex-direction: column; }
    input, button { padding: 14px; margin: 10px 0; font-size: 16px; border-radius: 8px; width: 100%; max-width: 400px; }
    button { background: #6c5ce7; color: white; border: none; cursor: pointer; }
    .header { display: flex; justify-content: space-between; margin-bottom: 20px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px,1fr)); gap: 20px; }
    .product { background: white; padding: 16px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .order-card { background: white; padding: 16px; margin: 10px 0; border-radius: 10px; }
    .qr-box { background: white; padding: 20px; text-align: center; margin: 20px auto; max-width: 300px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .wb-logo { color: #6c5ce7; font-size: 24px; font-weight: bold; margin: 10px 0; }
    .barcode-display { font-family: "OCRB", monospace; font-size: 18px; margin: 10px 0; letter-spacing: 2px; }
  </style>
</head>
<body>

<div id="login" class="screen">
  <h2>Вход по телефону</h2>
  <input type="tel" id="phone" placeholder="79991234567" maxlength="11" autofocus />
  <button onclick="login()">Войти</button>
</div>

<div id="main" class="screen">
  <div class="header">
    <h2>Каталог</h2>
    <button onclick="showOrders()">Мои заказы</button>
  </div>
  <div class="grid" id="products"></div>
</div>

<div id="orders" class="screen">
  <h2>Мои заказы</h2>
  <button onclick="showMain()">← Назад</button>
  <div id="orders-list"></div>
</div>

<div id="order-detail" class="screen">
  <h2>Детали заказа</h2>
  <button onclick="showOrders()">← Назад</button>
  <div id="order-info"></div>
  <!-- QR + ШТРИХКОД -->
  <div class="qr-box" id="qr-box" style="display:none;">
    <div class="wb-logo">WB</div>
    <div id="qr-code"></div>
    <svg id="barcode-svg" style="width:100%; height:60px; margin:10px 0;"></svg>
    <div class="barcode-display" id="barcode-number"></div>
  </div>
</div>

<script>
  const firebaseConfig = {
    databaseURL: "https://renessans-bank-3df94-default-rtdb.europe-west1.firebasedatabase.app/"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let user = null;
  const products = Array.from({length: 100}, (_, i) => ({
    id: i+1,
    name: `Товар ${i+1}`,
    price: 100 + i*10
  }));

  function login() {
    const p = document.getElementById("phone").value.replace(/\D/g, '');
    if (p.length !== 11 || !p.startsWith('7')) return alert("Формат: 79991234567");
    user = p;
    showMain();
    render();
  }

  function showMain() {
    document.getElementById("login").style.display = "none";
    document.getElementById("orders").style.display = "none";
    document.getElementById("order-detail").style.display = "none";
    document.getElementById("main").style.display = "flex";
  }

  function render() {
    document.getElementById("products").innerHTML = products.map(p => 
      `<div class="product">${p.name} — ${p.price} ₽<br><button onclick="order(${p.id})">Заказать</button></div>`
    ).join('');
  }

  function order(productId) {
    const product = products.find(p => p.id === productId);
    const orderData = {
      userId: user,
      items: [product],
      total: product.price,
      paymentMethod: "cash",
      status: "created",
      pvzAddress: "Г. Балашиха, проспект Ленина, 32Д",
      timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    db.ref('orders').push(orderData);
    alert("Заказ оформлен!");
  }

  function showOrders() {
    document.getElementById("main").style.display = "none";
    document.getElementById("orders").style.display = "flex";
    db.ref('orders').orderByChild('userId').equalTo(user).once('value', snap => {
      const list = document.getElementById("orders-list");
      list.innerHTML = "";
      if (!snap.exists()) {
        list.innerHTML = "<p>Нет заказов</p>";
        return;
      }
      snap.forEach(child => {
        const o = child.val();
        const status = o.status === 'received' ? 'Готов к выдаче' : 'Ожидает';
        const div = document.createElement("div");
        div.className = "order-card";
        div.innerHTML = `
          Заказ №${child.key.slice(-6)}<br>
          Статус: ${status}<br>
          <button onclick="showDetail('${child.key}')">Подробнее</button>
        `;
        list.appendChild(div);
      });
    });
  }

  function showDetail(orderId) {
    db.ref('orders/' + orderId).once('value', snap => {
      const order = snap.val();
      document.getElementById("orders").style.display = "none";
      document.getElementById("order-detail").style.display = "flex";
      
      document.getElementById("order-info").innerHTML = `
        Заказ №${orderId.slice(-6)}<br>
        Статус: ${order.status}<br>
        Товар: ${order.items[0].name}
      `;

      // Генерация QR
      const qrData = JSON.stringify({ orderId: orderId, userId: order.userId });
      document.getElementById("qr-code").innerHTML = "";
      new QRCode(document.getElementById("qr-code"), { text: qrData, width: 180, height: 180 });

      // ✅ ГЕНЕРАЦИЯ ШТРИХКОДА С ЦИФРАМИ (EAN-13)
      const now = Date.now().toString().slice(-9);
      const nameHash = order.items[0].name.split('').reduce((a, b) => ((a << 5) - a + b.charCodeAt(0)) | 0, 0).toString().replace('-', '').slice(0,3);
      let code12 = (now + nameHash).padEnd(12, '0').slice(0,12);
      let sum = 0;
      for (let i = 0; i < 12; i++) sum += parseInt(code12[i]) * (i % 2 === 0 ? 1 : 3);
      const check = (10 - (sum % 10)) % 10;
      const barcode = code12 + check;

      // Отображение штрихкода
      JsBarcode("#barcode-svg", barcode, {
        format: "EAN13",
        lineColor: "#000",
        height: 50,
        fontSize: 16,
        displayValue: true,
        textAlign: "center"
      });
      document.getElementById("barcode-number").textContent = barcode;
      document.getElementById("qr-box").style.display = "block";
    });
  }

  document.getElementById("login").style.display = "flex";
</script>

</body>
</html>
